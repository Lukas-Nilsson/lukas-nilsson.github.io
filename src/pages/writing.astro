---
import { getCollection } from 'astro:content';
import ContentPage from '../layouts/ContentPage.astro';

const entries = await getCollection('public');
const writingEntry = entries.find(entry => entry.id === 'Writing/index.md');

if (!writingEntry) {
  return Astro.redirect('/404');
}

const posts = entries
  .filter(e => e.id.startsWith('Writing/') && !e.id.endsWith('index.md') && e.data.publish === true)
  .sort((a, b) => {
    const da = new Date(a.data.updated ?? 0).getTime();
    const db = new Date(b.data.updated ?? 0).getTime();
    return db - da;
  });

const { Content } = await writingEntry.render();
const { title, summary } = writingEntry.data;
---

<ContentPage title={title} description={summary}>
  <Content />

  {posts.length > 0 && (
    <section aria-label="Articles" class="post-list">
      <h2>Articles</h2>
      <ul>
        {posts.map((post) => {
          const slug = post.id.replace('Writing/', '').replace('.md', '');
          return (
            <li>
              <a href={`/writing/${slug}/`}>{post.data.title ?? slug}</a>
              {post.data.summary && (
                <p class="summary">{post.data.summary}</p>
              )}
            </li>
          );
        })}
      </ul>
    </section>
  )}

  <style>
    .post-list { margin-top: var(--space-2xl); }
    .post-list h2 { margin-bottom: var(--space-lg); }
    .post-list ul { display: grid; gap: var(--space-lg); padding: 0; list-style: none; }
    .post-list li { border: 1px solid var(--color-border); border-radius: 12px; padding: var(--space-lg); }
    .post-list a { color: var(--color-text); text-decoration: none; font-weight: 600; font-size: var(--text-lg); }
    .post-list a:hover { color: var(--color-accent); }
    .post-list .summary { margin-top: var(--space-sm); color: var(--color-text-muted); }
  </style>
</ContentPage>

