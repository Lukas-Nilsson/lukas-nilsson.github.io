---
const navItems = [
  { name: 'About', href: '/about' },
  { name: 'Projects', href: '/projects' },
  { name: 'Writing', href: '/writing' },
  { name: 'Contact', href: '/contact' },
];

const currentPath = Astro.url.pathname;
---

<nav class="nav-capsule" id="main-nav">
  <!-- Desktop Floating Capsule -->
  <div class="nav-pill">
    <a href="/" class="nav-home" aria-label="Home">
      <span class="nav-home-text">LN</span>
    </a>
    
    <div class="nav-divider" aria-hidden="true"></div>
    
    <ul class="nav-links">
      {navItems.map(item => (
        <li>
          <a 
            href={item.href}
            class:list={['nav-link', { active: currentPath.startsWith(item.href) }]}
            aria-current={currentPath.startsWith(item.href) ? 'page' : undefined}
          >
            {item.name}
          </a>
        </li>
      ))}
    </ul>

    <!-- Sliding active indicator -->
    <div class="nav-indicator" aria-hidden="true"></div>
    
    <!-- Visual Mode Toggle -->
    <button 
      class="visual-mode-toggle" 
      id="visual-mode-toggle"
      aria-label="Toggle enhanced visual mode"
      title="Toggle enhanced visual mode"
    >
      <svg class="icon-default" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="4"></circle>
        <circle cx="12" cy="12" r="10" opacity="0.3"></circle>
      </svg>
      <svg class="icon-enhanced" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
      </svg>
    </button>
  </div>
</nav>

<!-- Mobile Menu Button (only on mobile) - Outside nav-capsule for proper positioning -->
<button 
  class="nav-mobile-toggle" 
  aria-label="Toggle menu"
  aria-expanded="false"
  id="menu-toggle"
>
  <span class="toggle-bar"></span>
  <span class="toggle-bar"></span>
  <span class="toggle-bar"></span>
</button>

<!-- Mobile Visual Mode Toggle (only on mobile, top right) - Outside nav-capsule for proper positioning -->
<button 
  class="nav-mobile-visual-toggle" 
  id="visual-mode-toggle-mobile"
  aria-label="Toggle enhanced visual mode"
  title="Toggle enhanced visual mode"
>
  <svg class="icon-default" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="12" cy="12" r="4"></circle>
    <circle cx="12" cy="12" r="10" opacity="0.3"></circle>
  </svg>
  <svg class="icon-enhanced" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
  </svg>
</button>

<!-- Mobile Navigation Overlay -->
<div class="nav-mobile-overlay" id="nav-overlay" aria-hidden="true">
  <div class="nav-mobile-backdrop" id="nav-backdrop"></div>
  <div class="nav-mobile-menu">
    <div class="nav-mobile-header">
      <a href="/" class="nav-mobile-home">LN</a>
    </div>
    <ul class="nav-mobile-list">
      {navItems.map(item => (
        <li>
          <a 
            href={item.href}
            class:list={['nav-mobile-link', { active: currentPath.startsWith(item.href) }]}
            aria-current={currentPath.startsWith(item.href) ? 'page' : undefined}
          >
            {item.name}
          </a>
        </li>
      ))}
    </ul>
  </div>
</div>

<style>
  /* =========================================
     FLOATING CAPSULE NAVIGATION
     ========================================= */

  .nav-capsule {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 1.5rem);
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    pointer-events: none;
    width: 100%;
    max-width: calc(var(--content-width) + 2rem); /* Match content width */
    padding: 0 1rem;
  }

  /* The floating pill/capsule */
  .nav-pill {
    display: none; /* Hidden on mobile */
    align-items: center;
    justify-content: space-between; /* Space out elements elegantly */
    gap: 1.5rem;
    padding: 0.625rem 1.5rem;
    width: 100%;
    
    /* Floating capsule glass effect - white tinted for light mode */
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    
    /* Capsule shape */
    border-radius: 100px;
    border: 1px solid rgba(0, 0, 0, 0.08);
    
    /* Subtle shadow - no glow */
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.1),
      0 8px 32px rgba(0, 0, 0, 0.05);
    
    pointer-events: auto;
    position: relative;
    
    transition: transform 400ms cubic-bezier(0.32, 0.72, 0, 1),
                opacity 400ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  /* Dark mode glass - black tinted for dark mode */
  [data-theme="dark"] .nav-pill {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(40px);
    -webkit-backdrop-filter: blur(40px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.5),
      0 8px 32px rgba(0, 0, 0, 0.3);
  }

  @media (min-width: 768px) {
    .nav-pill {
      display: flex;
    }
  }

  /* Hide on scroll down, show on scroll up */
  .nav-capsule.nav-hidden .nav-pill {
    transform: translateY(-120%) translateX(-50%);
    opacity: 0;
    pointer-events: none;
  }

  /* Home button/logo */
  .nav-home {
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: transform 200ms cubic-bezier(0.32, 0.72, 0, 1);
    height: 44px; /* Match nav-link height for alignment */
  }

  .nav-home:active {
    transform: scale(0.92);
  }

  .nav-home-text {
    font-size: 1rem;
    font-weight: 700;
    color: var(--color-text);
    letter-spacing: -0.02em;
    line-height: 1; /* Prevent extra vertical space */
  }

  /* Divider */
  .nav-divider {
    width: 1px;
    height: 20px;
    background: var(--color-border);
    margin: 0 0.25rem;
  }

  /* Navigation links */
  .nav-links {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
    position: relative;
    flex: 1; /* Take remaining space */
    justify-content: flex-end; /* Align to right */
  }

  .nav-link {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    height: 44px;
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--color-text-muted);
    text-decoration: none;
    border-radius: 50px;
    transition: color 200ms cubic-bezier(0.32, 0.72, 0, 1),
                transform 150ms cubic-bezier(0.32, 0.72, 0, 1);
    position: relative;
    z-index: 2;
    line-height: 1;
  }

  .nav-link:hover {
    color: var(--color-text);
  }

  .nav-link:active {
    transform: scale(0.95);
  }

  .nav-link.active {
    color: var(--color-text);
  }

  /* Floating active indicator (pill behind active item) */
  .nav-indicator {
    position: absolute;
    top: 50%;
    left: var(--indicator-left, 0);
    transform: translateY(-50%);
    width: var(--indicator-width, 0);
    height: calc(100% - 8px);
    background: rgba(0, 0, 0, 0.06);
    border-radius: 50px;
    transition: left 300ms cubic-bezier(0.32, 0.72, 0, 1),
                width 300ms cubic-bezier(0.32, 0.72, 0, 1),
                opacity 200ms ease;
    opacity: var(--indicator-opacity, 0);
    pointer-events: none;
    z-index: 1;
  }

  [data-theme="dark"] .nav-indicator {
    background: rgba(255, 255, 255, 0.18);
  }

  /* Focus states */
  .nav-link:focus-visible,
  .nav-home:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 4px;
  }

  /* =========================================
     VISUAL MODE TOGGLE
     ========================================= */

  .visual-mode-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    padding: 0;
    border: none;
    background: none;
    color: var(--color-text-muted);
    cursor: pointer;
    border-radius: 50%;
    transition: all 200ms cubic-bezier(0.32, 0.72, 0, 1);
    position: relative;
    margin-left: var(--space-xs);
  }

  .visual-mode-toggle:hover {
    background: rgba(0, 0, 0, 0.05);
    color: var(--color-text);
  }

  [data-theme="dark"] .visual-mode-toggle:hover {
    background: rgba(255, 255, 255, 0.08);
  }

  /* Satisfying press - like a physical button */
  .visual-mode-toggle:active {
    transform: scale(0.85);
  }

  .visual-mode-toggle:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Smooth icon crossfade */
  .visual-mode-toggle svg {
    transition: all 300ms cubic-bezier(0.32, 0.72, 0, 1);
    position: absolute;
  }

  .visual-mode-toggle .icon-default {
    opacity: 1;
    transform: scale(1);
  }

  .visual-mode-toggle .icon-enhanced {
    opacity: 0;
    transform: scale(0.8);
  }

  [data-visual-mode="enhanced"] .visual-mode-toggle .icon-default {
    opacity: 0;
    transform: scale(0.8);
  }

  [data-visual-mode="enhanced"] .visual-mode-toggle .icon-enhanced {
    opacity: 1;
    transform: scale(1);
  }

  /* =========================================
     MOBILE TOGGLE BUTTONS (Hamburger & Visual Mode)
     ========================================= */

  /* Hamburger menu - Top Left */
  .nav-mobile-toggle {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 1.5rem);
    left: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    width: 44px;
    height: 44px;
    padding: 0;
    border: none;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.08);
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.1),
      0 8px 32px rgba(0, 0, 0, 0.05);
    cursor: pointer;
    z-index: 1001;
    transition: transform 200ms cubic-bezier(0.32, 0.72, 0, 1);
    -webkit-tap-highlight-color: transparent;
  }

  [data-theme="dark"] .nav-mobile-toggle {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(40px);
    -webkit-backdrop-filter: blur(40px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.5),
      0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .nav-mobile-toggle:active {
    transform: scale(0.92);
  }

  @media (min-width: 768px) {
    .nav-mobile-toggle {
      display: none;
    }
  }

  .toggle-bar {
    width: 18px;
    height: 2px;
    background: var(--color-text);
    border-radius: 1px;
    transition: all 300ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  .nav-mobile-toggle[aria-expanded="true"] .toggle-bar:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
  }

  .nav-mobile-toggle[aria-expanded="true"] .toggle-bar:nth-child(2) {
    opacity: 0;
  }

  .nav-mobile-toggle[aria-expanded="true"] .toggle-bar:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
  }

  /* =========================================
     MOBILE OVERLAY MENU
     ========================================= */

  .nav-mobile-overlay {
    position: fixed;
    inset: 0;
    z-index: 999;
    pointer-events: none;
    opacity: 0;
  }

  .nav-mobile-overlay[aria-hidden="false"] {
    pointer-events: auto;
    opacity: 1;
  }

  @media (min-width: 768px) {
    .nav-mobile-overlay {
      display: none !important;
    }
  }

  .nav-mobile-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    -webkit-backdrop-filter: blur(0px);
    transition: background 400ms cubic-bezier(0.32, 0.72, 0, 1),
                backdrop-filter 400ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  .nav-mobile-overlay[aria-hidden="false"] .nav-mobile-backdrop {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .nav-mobile-menu {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: min(340px, 85vw);
    
    /* Light mode - cleaner, less grey blur */
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(40px);
    -webkit-backdrop-filter: blur(40px);
    
    box-shadow: 4px 0 32px rgba(0, 0, 0, 0.08);
    transform: translateX(-100%);
    transition: transform 400ms cubic-bezier(0.32, 0.72, 0, 1);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: calc(env(safe-area-inset-top) + 1rem);
    border-right: 1px solid rgba(0, 0, 0, 0.06);
  }

  /* Dark mode - black tinted for dark mode */
  [data-theme="dark"] .nav-mobile-menu {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(40px);
    -webkit-backdrop-filter: blur(40px);
    box-shadow: 4px 0 32px rgba(0, 0, 0, 0.5);
    border-right: 1px solid rgba(255, 255, 255, 0.06);
  }

  .nav-mobile-overlay[aria-hidden="false"] .nav-mobile-menu {
    transform: translateX(0);
  }

  .nav-mobile-header {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem 1.5rem 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .nav-mobile-home {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-text);
    text-decoration: none;
    letter-spacing: -0.02em;
    opacity: 0.5;
  }

  .nav-mobile-list {
    list-style: none;
    padding: 2rem 1.5rem;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .nav-mobile-link {
    display: block;
    padding: 1rem 1.25rem;
    font-size: 1.125rem;
    font-weight: 500;
    color: var(--color-text);
    text-decoration: none;
    border-radius: 14px;
    transition: all 250ms cubic-bezier(0.32, 0.72, 0, 1);
    -webkit-tap-highlight-color: transparent;
  }

  .nav-mobile-link:hover {
    background: rgba(0, 0, 0, 0.05);
    transform: translateX(4px);
  }

  [data-theme="dark"] .nav-mobile-link:hover {
    background: rgba(255, 255, 255, 0.03);
  }

  .nav-mobile-link:active {
    transform: translateX(4px) scale(0.98);
  }

  .nav-mobile-link.active {
    color: var(--color-accent);
    background: rgba(0, 0, 0, 0.08);
    font-weight: 600;
  }

  [data-theme="dark"] .nav-mobile-link.active {
    color: var(--color-accent);
    background: rgba(255, 255, 255, 0.05);
  }

  /* Mobile Visual Mode Toggle - Top Right (mirrors hamburger) */
  .nav-mobile-visual-toggle {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 1.5rem);
    right: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    padding: 0;
    border: none;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.08);
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.1),
      0 8px 32px rgba(0, 0, 0, 0.05);
    color: var(--color-text-muted);
    cursor: pointer;
    z-index: 1002; /* Higher than hamburger menu */
    transition: transform 200ms cubic-bezier(0.32, 0.72, 0, 1);
    -webkit-tap-highlight-color: transparent;
  }

  [data-theme="dark"] .nav-mobile-visual-toggle {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(40px);
    -webkit-backdrop-filter: blur(40px);
    border: 1px solid rgba(255, 255, 255, 0.06);
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.5),
      0 8px 32px rgba(0, 0, 0, 0.3);
  }

  /* Satisfying press */
  .nav-mobile-visual-toggle:active {
    transform: scale(0.85);
  }

  @media (min-width: 768px) {
    .nav-mobile-visual-toggle {
      display: none;
    }
  }

  /* Smooth icon crossfade */
  .nav-mobile-visual-toggle svg {
    transition: all 300ms cubic-bezier(0.32, 0.72, 0, 1);
    position: absolute;
  }

  .nav-mobile-visual-toggle .icon-default {
    opacity: 1;
    transform: scale(1);
  }

  .nav-mobile-visual-toggle .icon-enhanced {
    opacity: 0;
    transform: scale(0.8);
  }

  [data-visual-mode="enhanced"] .nav-mobile-visual-toggle .icon-default {
    opacity: 0;
    transform: scale(0.8);
  }

  [data-visual-mode="enhanced"] .nav-mobile-visual-toggle .icon-enhanced {
    opacity: 1;
    transform: scale(1);
  }

  /* Prevent body scroll when overlay open */
  body:has(.nav-mobile-overlay[aria-hidden="false"]) {
    overflow: hidden;
  }
</style>

<script>
  /* =========================================
     MOBILE MENU
     ========================================= */

  const toggle = document.getElementById('menu-toggle');
  const overlay = document.getElementById('nav-overlay');
  const backdrop = document.getElementById('nav-backdrop');

  function openMenu() {
    if (!toggle || !overlay) return;
    toggle.setAttribute('aria-expanded', 'true');
    overlay.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }

  function closeMenu() {
    if (!toggle || !overlay) return;
    toggle.setAttribute('aria-expanded', 'false');
    overlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  toggle?.addEventListener('click', () => {
    const isOpen = toggle.getAttribute('aria-expanded') === 'true';
    isOpen ? closeMenu() : openMenu();
  });

  backdrop?.addEventListener('click', closeMenu);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay?.getAttribute('aria-hidden') === 'false') {
      closeMenu();
    }
  });

  const mobileLinks = overlay?.querySelectorAll('.nav-mobile-link');
  mobileLinks?.forEach(link => {
    link.addEventListener('click', closeMenu);
  });

  /* =========================================
     SMART HIDE/SHOW ON SCROLL (Desktop)
     ========================================= */

  const nav = document.getElementById('main-nav');
  let lastScrollY = 0;
  let scrollThreshold = 80;
  let ticking = false;

  function updateNavOnScroll() {
    const currentScrollY = window.scrollY;
    
    if (!nav || window.innerWidth < 768) return;

    // Hide when scrolling down, show when scrolling up
    if (currentScrollY > scrollThreshold) {
      if (currentScrollY > lastScrollY) {
        nav.classList.add('nav-hidden');
      } else {
        nav.classList.remove('nav-hidden');
      }
    } else {
      nav.classList.remove('nav-hidden');
    }

    lastScrollY = currentScrollY;
    ticking = false;
  }

  window.addEventListener('scroll', () => {
    if (!ticking) {
      requestAnimationFrame(updateNavOnScroll);
      ticking = true;
    }
  }, { passive: true });

  /* =========================================
     SLIDING INDICATOR (Desktop)
     ========================================= */

  function initIndicator() {
    if (window.innerWidth < 768) return;

    const links = document.querySelector('.nav-links') as HTMLElement | null;
    const indicator = document.querySelector('.nav-indicator') as HTMLElement | null;
    const navLinks = Array.from(document.querySelectorAll('.nav-link')) as HTMLAnchorElement[];
    
    if (!links || !indicator || navLinks.length === 0) return;

    const setIndicatorTo = (el: HTMLElement | null) => {
      if (!links || !el) return;
      const linksRect = links.getBoundingClientRect();
      const rect = el.getBoundingClientRect();
      const left = rect.left - linksRect.left;
      const width = rect.width;
      
      links.style.setProperty('--indicator-left', left + 'px');
      links.style.setProperty('--indicator-width', width + 'px');
      links.style.setProperty('--indicator-opacity', '1');
    };

    const active = navLinks.find(l => l.classList.contains('active')) || navLinks[0];
    
    // Set initial position after DOM is ready
    requestAnimationFrame(() => {
      setIndicatorTo(active);
    });

    navLinks.forEach(link => {
      link.addEventListener('mouseenter', () => setIndicatorTo(link));
      link.addEventListener('focus', () => setIndicatorTo(link));
    });

    links.addEventListener('mouseleave', () => setIndicatorTo(active));
    window.addEventListener('resize', () => setIndicatorTo(active));
  }

  document.addEventListener('DOMContentLoaded', initIndicator);
  
  /* =========================================
     VISUAL MODE TOGGLE (Desktop & Mobile)
     ========================================= */
  
  function toggleVisualMode() {
    const currentMode = document.documentElement.getAttribute('data-visual-mode') || 'default';
    const newMode = currentMode === 'default' ? 'enhanced' : 'default';
    
    // Subtle haptic feedback
    if ('vibrate' in navigator) {
      navigator.vibrate(15);
    }
    
    // Immediate toggle
    document.documentElement.setAttribute('data-visual-mode', newMode);
    localStorage.setItem('visual-mode', newMode);
  }
  
  // Desktop toggle
  const visualModeToggle = document.getElementById('visual-mode-toggle');
  visualModeToggle?.addEventListener('click', toggleVisualMode);
  
  // Mobile toggle
  const visualModeToggleMobile = document.getElementById('visual-mode-toggle-mobile');
  visualModeToggleMobile?.addEventListener('click', toggleVisualMode);
</script>
