---
const navItems = [
  { name: 'About', href: '/about' },
  { name: 'Projects', href: '/projects' },
  { name: 'Writing', href: '/writing' },
  { name: 'Contact', href: '/contact' },
];

const currentPath = Astro.url.pathname;
---

<nav class="nav" id="main-nav">
  <div class="nav-container">
    <a href="/" class="nav-logo" aria-label="Home">LN</a>
    
    <!-- Desktop Navigation -->
    <ul class="nav-menu">
      {navItems.map(item => (
        <li>
          <a 
            href={item.href}
            class:list={['nav-link', { active: currentPath.startsWith(item.href) }]}
            aria-current={currentPath.startsWith(item.href) ? 'page' : undefined}
          >
            {item.name}
          </a>
        </li>
      ))}
      <li>
        <button 
          class="theme-toggle"
          aria-label="Toggle dark mode"
          id="theme-toggle"
          title="Toggle dark mode"
        >
          <span class="theme-icon" aria-hidden="true">ðŸŒ™</span>
        </button>
      </li>
    </ul>

    <!-- Mobile Menu Button -->
    <button 
      class="nav-toggle" 
      aria-label="Toggle menu"
      aria-expanded="false"
      id="menu-toggle"
    >
      <span class="nav-toggle-icon"></span>
    </button>
  </div>

  <!-- Mobile Navigation Overlay -->
  <div class="nav-overlay" id="nav-overlay" aria-hidden="true">
    <div class="nav-backdrop" id="nav-backdrop"></div>
    <div class="nav-menu-mobile">
      <ul class="nav-menu-mobile-list">
        {navItems.map(item => (
          <li>
            <a 
              href={item.href}
              class:list={['nav-link-mobile', { active: currentPath.startsWith(item.href) }]}
              aria-current={currentPath.startsWith(item.href) ? 'page' : undefined}
            >
              {item.name}
            </a>
          </li>
        ))}
        <li>
          <button 
            class="theme-toggle-mobile nav-link-mobile"
            aria-label="Toggle dark mode"
            id="theme-toggle-mobile"
          >
            <span>ðŸŒ™</span> Theme
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<style>
  /* =========================================
     NAVIGATION - Apple-Inspired UX
     ========================================= */

  .nav {
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid var(--color-border);
    background: var(--color-bg);
    transition: transform 300ms cubic-bezier(0.32, 0.72, 0, 1),
                box-shadow 300ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  .nav.nav-hidden {
    transform: translateY(-100%);
  }

  .nav.nav-scrolled {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .nav-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--space-sm) var(--space-md);
  }

  /* Logo with spring animation */
  .nav-logo {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text);
    text-decoration: none;
    transition: color 200ms cubic-bezier(0.32, 0.72, 0, 1),
                transform 200ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  .nav-logo:hover {
    color: var(--color-accent);
    transform: scale(1.05);
  }

  .nav-logo:active {
    transform: scale(0.95);
  }

  /* Desktop Menu */
  .nav-menu {
    display: none;
    list-style: none;
    gap: var(--space-lg);
  }

  @media (min-width: 768px) {
    .nav-menu {
      display: flex;
    }
  }

  /* Desktop Nav Links with underline animation */
  .nav-link {
    position: relative;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    text-decoration: none;
    padding: var(--space-xs) 0;
    transition: color 200ms cubic-bezier(0.32, 0.72, 0, 1),
                transform 200ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  .nav-link::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    right: 50%;
    height: 2px;
    background: var(--color-accent);
    opacity: 0;
    transition: all 200ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  .nav-link:hover {
    color: var(--color-text);
  }

  .nav-link:hover::before {
    left: 0;
    right: 0;
    opacity: 0.8;
  }

  .nav-link:active {
    transform: scale(0.95);
    opacity: 0.6;
  }

  .nav-link.active {
    color: var(--color-text);
  }

  .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--color-accent);
  }

  /* Apple-style focus states */
  .nav-link:focus-visible,
  .nav-logo:focus-visible {
    outline: 3px solid var(--color-accent);
    outline-offset: 4px;
    border-radius: 4px;
  }

  /* Theme Toggle Button */
  .theme-toggle {
    width: 44px;
    height: 44px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
    transition: all 200ms cubic-bezier(0.32, 0.72, 0, 1);
    border-radius: 8px;
    -webkit-tap-highlight-color: transparent;
  }

  .theme-toggle:hover {
    color: var(--color-text);
    background: rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .theme-toggle:active {
    transform: scale(0.95);
  }

  .theme-toggle:focus-visible {
    outline: 3px solid var(--color-accent);
    outline-offset: 4px;
  }

  .theme-icon {
    font-size: 20px;
    line-height: 1;
    transition: transform 300ms cubic-bezier(0.32, 0.72, 0, 1);
    display: inline-block;
  }

  [data-theme="dark"] .theme-icon {
    transform: rotate(180deg);
  }

  /* Micro-interaction: Theme icon bounce on click */
  .theme-toggle:active .theme-icon {
    transform: scale(1.2);
  }

  [data-theme="dark"] .theme-toggle:active .theme-icon {
    transform: rotate(180deg) scale(1.2);
  }

  .theme-toggle-mobile {
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-size: var(--text-lg);
    font-weight: 500;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    border-radius: 8px;
    transition: all 200ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  .theme-toggle-mobile:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .theme-toggle-mobile:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .theme-toggle-mobile:active {
    transform: scale(0.97);
  }

  /* Mobile Toggle Button with haptic feedback */
  .nav-toggle {
    display: block;
    width: 44px;
    height: 44px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    position: relative;
    transition: transform 200ms cubic-bezier(0.32, 0.72, 0, 1);
    -webkit-tap-highlight-color: transparent;
  }

  .nav-toggle:active {
    transform: scale(0.9);
  }

  .nav-toggle:focus-visible {
    outline: 3px solid var(--color-accent);
    outline-offset: 4px;
    border-radius: 8px;
  }

  @media (min-width: 768px) {
    .nav-toggle {
      display: none;
    }
  }

  /* Hamburger animation with spring physics */
  .nav-toggle-icon,
  .nav-toggle-icon::before,
  .nav-toggle-icon::after {
    position: absolute;
    width: 24px;
    height: 2px;
    background: var(--color-text);
    transition: all 300ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  .nav-toggle-icon {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .nav-toggle-icon::before,
  .nav-toggle-icon::after {
    content: '';
    left: 0;
  }

  .nav-toggle-icon::before {
    top: -8px;
  }

  .nav-toggle-icon::after {
    top: 8px;
  }

  .nav-toggle[aria-expanded="true"] .nav-toggle-icon {
    background: transparent;
  }

  .nav-toggle[aria-expanded="true"] .nav-toggle-icon::before {
    top: 0;
    transform: rotate(45deg);
  }

  .nav-toggle[aria-expanded="true"] .nav-toggle-icon::after {
    top: 0;
    transform: rotate(-45deg);
  }

  /* =========================================
     MOBILE MENU OVERLAY (iOS-Style)
     ========================================= */

  .nav-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    /* Don't transition overlay opacity - let blur handle visual transition */
  }

  .nav-overlay[aria-hidden="false"] {
    pointer-events: auto;
    opacity: 1;
    /* Show immediately when menu opens */
  }

  @media (min-width: 768px) {
    .nav-overlay {
      display: none !important;
    }
  }

  /* Backdrop with blur (iOS style) - Starts transitioning immediately */
  .nav-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    -webkit-backdrop-filter: blur(0px);
    /* Start transitioning as soon as overlay becomes visible */
    transition: background 400ms cubic-bezier(0.32, 0.72, 0, 1),
                backdrop-filter 400ms cubic-bezier(0.32, 0.72, 0, 1);
    will-change: backdrop-filter, background;
  }

  /* Transition starts immediately when overlay is shown */
  .nav-overlay[aria-hidden="false"] .nav-backdrop {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  /* Mobile menu panel slides from right */
  .nav-menu-mobile {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: min(300px, 75vw);
    background: var(--color-bg);
    box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
    transform: translateX(100%);
    transition: transform 400ms cubic-bezier(0.32, 0.72, 0, 1);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .nav-overlay[aria-hidden="false"] .nav-menu-mobile {
    transform: translateX(0);
  }

  .nav-menu-mobile-list {
    list-style: none;
    padding: var(--space-2xl) var(--space-lg);
  }

  .nav-menu-mobile-list li {
    margin-bottom: var(--space-xs);
    opacity: 0;
    transform: translateX(20px);
    transition: all 400ms cubic-bezier(0.32, 0.72, 0, 1);
  }

  /* Staggered fade-in animation */
  .nav-overlay[aria-hidden="false"] .nav-menu-mobile-list li {
    opacity: 1;
    transform: translateX(0);
  }

  .nav-overlay[aria-hidden="false"] .nav-menu-mobile-list li:nth-child(1) {
    transition-delay: 100ms;
  }

  .nav-overlay[aria-hidden="false"] .nav-menu-mobile-list li:nth-child(2) {
    transition-delay: 150ms;
  }

  .nav-overlay[aria-hidden="false"] .nav-menu-mobile-list li:nth-child(3) {
    transition-delay: 200ms;
  }

  .nav-overlay[aria-hidden="false"] .nav-menu-mobile-list li:nth-child(4) {
    transition-delay: 250ms;
  }

  /* Mobile nav links */
  .nav-link-mobile {
    display: block;
    font-size: var(--text-lg);
    font-weight: 500;
    color: var(--color-text);
    text-decoration: none;
    padding: var(--space-md);
    border-radius: 8px;
    transition: background 200ms cubic-bezier(0.32, 0.72, 0, 1),
                transform 200ms cubic-bezier(0.32, 0.72, 0, 1),
                color 200ms cubic-bezier(0.32, 0.72, 0, 1);
    -webkit-tap-highlight-color: transparent;
  }

  .nav-link-mobile:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  .nav-link-mobile:active {
    transform: scale(0.97);
    background: rgba(0, 0, 0, 0.1);
  }

  .nav-link-mobile.active {
    color: var(--color-accent);
    background: rgba(59, 130, 246, 0.1);
  }

  .nav-link-mobile:focus-visible {
    outline: 3px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Prevent body scroll when menu open */
  body:has(.nav-overlay[aria-hidden="false"]) {
    overflow: hidden;
  }
</style>

<script>
  /* =========================================
     APPLE-INSPIRED NAVIGATION INTERACTIONS
     ========================================= */

  // Mobile menu overlay system
  const toggle = document.getElementById('menu-toggle');
  const overlay = document.getElementById('nav-overlay');
  const backdrop = document.getElementById('nav-backdrop');
  const nav = document.getElementById('main-nav');

  function openMenu() {
    if (!toggle || !overlay) return;
    toggle.setAttribute('aria-expanded', 'true');
    
    // Show overlay immediately and trigger blur transition
    overlay.setAttribute('aria-hidden', 'false');
    
    // Force reflow to ensure transition starts immediately
    requestAnimationFrame(() => {
      // Trigger transition by accessing computed style
      void overlay.offsetHeight;
    });
    
    document.body.style.overflow = 'hidden';
  }

  function closeMenu() {
    if (!toggle || !overlay) return;
    toggle.setAttribute('aria-expanded', 'false');
    overlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  // Toggle button
  if (toggle) {
    toggle.addEventListener('click', () => {
      const isOpen = toggle.getAttribute('aria-expanded') === 'true';
      isOpen ? closeMenu() : openMenu();
    });
  }

  // Close on backdrop click
  if (backdrop) {
    backdrop.addEventListener('click', closeMenu);
  }

  // Close on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay?.getAttribute('aria-hidden') === 'false') {
      closeMenu();
    }
  });

  // Close menu when navigating (mobile links clicked)
  const mobileLinks = overlay?.querySelectorAll('.nav-link-mobile');
  mobileLinks?.forEach(link => {
    link.addEventListener('click', closeMenu);
  });

  /* =========================================
     SMART SCROLL BEHAVIOR (iOS Safari-style)
     ========================================= */

  let lastScrollY = 0;
  let scrollThreshold = 100;
  let ticking = false;

  function updateNavOnScroll() {
    const currentScrollY = window.scrollY;
    
    if (!nav) return;

    // Add shadow when scrolled
    if (currentScrollY > 10) {
      nav.classList.add('nav-scrolled');
    } else {
      nav.classList.remove('nav-scrolled');
    }

    // Hide/show nav based on scroll direction (only after threshold)
    if (currentScrollY > scrollThreshold) {
      if (currentScrollY > lastScrollY && currentScrollY > scrollThreshold) {
        // Scrolling down - hide nav
        nav.classList.add('nav-hidden');
      } else {
        // Scrolling up - show nav
        nav.classList.remove('nav-hidden');
      }
    }

    lastScrollY = currentScrollY;
    ticking = false;
  }

  // Throttled scroll handler for performance
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(updateNavOnScroll);
      ticking = true;
    }
  }, { passive: true });

  /* =========================================
     HAPTIC-STYLE FEEDBACK FOR LINKS
     ========================================= */

  // Add active state feedback to all nav links
  const allLinks = document.querySelectorAll('.nav-link, .nav-link-mobile, .nav-logo');
  
  allLinks.forEach(link => {
    link.addEventListener('touchstart', function() {
      this.style.transition = 'transform 100ms cubic-bezier(0.32, 0.72, 0, 1)';
    }, { passive: true });

    link.addEventListener('touchend', function() {
      this.style.transition = '';
    }, { passive: true });
  });

  /* =========================================
     THEME TOGGLE (Dark Mode)
     ========================================= */

  function getThemePreference() {
    // Check localStorage first
    const stored = localStorage.getItem('theme');
    if (stored === 'dark' || stored === 'light') {
      return stored;
    }
    // Fall back to system preference
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function setTheme(theme: 'dark' | 'light') {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
  }

  function toggleTheme() {
    const current = getThemePreference();
    const newTheme = current === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
    
    // Haptic feedback if available
    if ('vibrate' in navigator) {
      navigator.vibrate(10);
    }
  }

  // Initialize theme on load
  const initialTheme = getThemePreference();
  setTheme(initialTheme);

  // Listen for system theme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    // Only apply if user hasn't manually set a preference
    if (!localStorage.getItem('theme')) {
      setTheme(e.matches ? 'dark' : 'light');
    }
  });

  // Theme toggle buttons
  const themeToggle = document.getElementById('theme-toggle');
  const themeToggleMobile = document.getElementById('theme-toggle-mobile');

  themeToggle?.addEventListener('click', toggleTheme);
  themeToggleMobile?.addEventListener('click', () => {
    toggleTheme();
    closeMenu(); // Close mobile menu after toggling
  });

  /* =========================================
     SWIPE GESTURES (Mobile Navigation)
     ========================================= */

  if (overlay && 'ontouchstart' in window) {
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;

    const handleTouchStart = (e: TouchEvent) => {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
    };

    const handleTouchEnd = (e: TouchEvent) => {
      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;
      handleSwipe();
    };

    const handleSwipe = () => {
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      
      // Only trigger if horizontal swipe is dominant (> 2x vertical)
      if (Math.abs(deltaX) > Math.abs(deltaY) * 2) {
        // Swipe right to close (when menu is open)
        if (deltaX > 100 && overlay.getAttribute('aria-hidden') === 'false') {
          closeMenu();
          
          // Haptic feedback
          if ('vibrate' in navigator) {
            navigator.vibrate(10);
          }
        }
      }
    };

    overlay.addEventListener('touchstart', handleTouchStart, { passive: true });
    overlay.addEventListener('touchend', handleTouchEnd, { passive: true });
  }
</script>

